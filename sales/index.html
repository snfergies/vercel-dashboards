<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Franchise Sales Performance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{box-sizing:border-box}</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">
            <span id="storeTitle">Sales Performance Dashboard</span>
          </h1>
          <p class="text-gray-600">
            Franchise Location:
            <span id="storeLocation">—</span>
          </p>
        </div>
        <div class="flex items-center space-x-4">
          <select id="monthSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="2025-09">September 2025</option>
            <option value="2025-10">October 2025</option>
            <option value="2025-11">November 2025</option>
            <option value="2025-12">December 2025</option>
          </select>
          <button id="newMonthBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
            New Month
          </button>
        </div>
      </div>

      <!-- View Toggle -->
      <div class="flex space-x-2">
        <button id="weeklyView" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">Weekly</button>
        <button id="monthlyView" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">Monthly</button>
        <button id="quarterlyView" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">Quarterly</button>
        <button id="ytdView" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">YTD</button>
      </div>
    </div>

    <!-- Franchise Goals -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Franchise Goals</h2>
        <button id="setFranchiseGoalsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">
          Set Goals
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h3 class="font-semibold text-blue-800 mb-2">Monthly Sales Goal</h3>
          <p class="text-2xl font-bold text-blue-600" id="franchiseSalesGoal">$—</p>
          <div class="mt-2">
            <div class="text-sm text-blue-600">Current: <span id="currentSales">$—</span></div>
            <div class="w-full bg-blue-200 rounded-full h-2 mt-1">
              <div id="salesBar" class="bg-blue-600 h-2 rounded-full" style="width:0%"></div>
            </div>
            <div id="salesPct" class="text-xs text-blue-600 mt-1">—% of goal</div>
          </div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="font-semibold text-green-800 mb-2">Conversion Rate Goal</h3>
          <p class="text-2xl font-bold text-green-600" id="franchiseConversionGoal">—%</p>
          <div class="mt-2">
            <div class="text-sm text-green-600">Current: <span id="currentConv">—%</span></div>
            <div class="w-full bg-green-200 rounded-full h-2 mt-1">
              <div id="convBar" class="bg-green-600 h-2 rounded-full" style="width:0%"></div>
            </div>
            <div id="convPct" class="text-xs text-green-600 mt-1">—% of goal</div>
          </div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <h3 class="font-semibold text-purple-800 mb-2">Average Ticket Goal</h3>
          <p class="text-2xl font-bold text-purple-600" id="franchiseTicketGoal">$—</p>
          <div class="mt-2">
            <div class="text-sm text-purple-600">Current: <span id="currentTicket">$—</span></div>
            <div class="w-full bg-purple-200 rounded-full h-2 mt-1">
              <div id="ticketBar" class="bg-purple-600 h-2 rounded-full" style="width:0%"></div>
            </div>
            <div id="ticketPct" class="text-xs text-purple-600 mt-1">—% of goal</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Designer Management -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Designer Management</h2>
        <div class="flex space-x-3">
          <button id="addDesignerBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
            + Add Designer
          </button>
          <button id="uploadGoalsBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
            Upload Goals
          </button>
          <button id="updateProgressBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium">
            Update Progress
          </button>
        </div>
      </div>
    </div>

    <!-- Performance Table -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Designer Performance - <span id="currentViewTitle">Weekly View</span></h2>
        <p class="text-gray-600">Current Period: <span id="currentPeriod">Week of September 2-8, 2025</span></p>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designer</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Sales</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Rank</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Ticket</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Closing Rate</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Appointments</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Closed</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Goal</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Goal</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">vs Franchise Goals</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="designerTableBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modals (same IDs as your original so styles/UX match) -->
  <div id="addDesignerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Add New Designer</h3>
      <form id="addDesignerForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Designer Name</label>
          <input type="text" id="designerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Goal ($)</label>
          <input type="number" id="designerGoal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelAddDesigner" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Add Designer</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editDesignerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Edit Designer</h3>
      <form id="editDesignerForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Designer Name</label>
          <input type="text" id="editDesignerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Goal ($)</label>
          <input type="number" id="editDesignerGoal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelEditDesigner" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="uploadGoalsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-2">Upload Monthly Goals</h3>
      <p class="text-sm text-gray-600 mb-4">Setting goals for: <span id="goalsMonthDisplay" class="font-medium text-blue-600"></span></p>
      <div id="goalsForm" class="space-y-4"></div>
      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" id="cancelUploadGoals" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
        <button type="button" id="saveGoals" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Save Goals</button>
      </div>
    </div>
  </div>

  <div id="updateProgressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Update Weekly Progress</h3>
      <div id="progressForm" class="space-y-6"></div>
      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" id="cancelUpdateProgress" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
        <button type="button" id="saveProgress" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">Save Progress</button>
      </div>
    </div>
  </div>

  <div id="newMonthModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Create New Month</h3>
      <form id="newMonthForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
          <input type="month" id="newMonthInput" min="2025-09" max="2027-12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelNewMonth" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Create Month</button>
        </div>
      </form>
    </div>
  </div>

  <div id="deleteDesignerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Delete Designer</h3>
      <p class="text-gray-600 mb-6">Are you sure you want to delete <span id="deleteDesignerName" class="font-semibold"></span>? This action cannot be undone.</p>
      <div class="flex justify-end space-x-3">
        <button type="button" id="cancelDeleteDesigner" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
        <button type="button" id="confirmDeleteDesigner" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Delete Designer</button>
      </div>
    </div>
  </div>

  <div id="franchiseGoalsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-2">Set Franchise Goals</h3>
      <p class="text-sm text-gray-600 mb-4">Setting goals for: <span id="franchiseGoalsMonthDisplay" class="font-medium text-indigo-600"></span></p>
      <form id="franchiseGoalsForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
          <select id="franchiseGoalsMonthSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            <option value="2025-09">September 2025</option>
            <option value="2025-10">October 2025</option>
            <option value="2025-11">November 2025</option>
            <option value="2025-12">December 2025</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Sales Goal ($)</label>
          <input type="number" id="franchiseSalesGoalInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="150000" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Conversion Rate Goal (%)</label>
          <input type="number" id="franchiseConversionGoalInput" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="65" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Average Ticket Goal ($)</label>
          <input type="number" id="franchiseTicketGoalInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="1800" required>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelFranchiseGoals" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Save Goals</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========= URL params (slug, month) =========
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug') || 'downtown-seattle'; // change default if needed
    let currentMonth = params.get('month') || '2025-09';

    // ========= In-memory state =========
    let designers = []; // filled from API
    let currentView = 'weekly';
    let editingDesignerId = null;
    let deletingDesignerId = null;

    // Franchise goals (overridden by API if provided)
    let franchiseGoals = { salesGoal: 150000, conversionGoal: 65, ticketGoal: 1800 };
    let franchiseMeta = { name: '—', city: '', state: '' };
    let monthTotals = { sales: 0, avgTicket: 0, conversion: 0 };

    // ========= Helpers =========
    const safeNumber = (v, d=0) => Number.isFinite(v) ? v : d;
    const fmtMoney  = (n) => '$' + safeNumber(n).toLocaleString();
    const fmtPct    = (n) => safeNumber(n).toFixed(1) + '%';

    // ========= Fetch franchise data =========
    async function loadFranchise() {
      // GET /api/franchises/[slug]?month=YYYY-MM
      const url = `/api/franchises/${encodeURIComponent(slug)}?month=${encodeURIComponent(currentMonth)}`;

      let data;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        data = await res.json();
      } catch (e) {
        console.warn('Falling back to sample franchise data:', e);
        data = sampleFranchise();
      }

      // Expected shape (flexible, we guard each field):
      // {
      //   name, city, state,
      //   goals: { salesGoal, conversionGoal, ticketGoal },
      //   totals: { sales, avgTicket, conversion },
      //   designers: [
      //     { id, name, monthlySales, appointments, salesClosed, goal, avgTicket, conversionRate }
      //   ]
      // }

      franchiseMeta.name = data.name || 'Franchise';
      franchiseMeta.city = data.city || '';
      franchiseMeta.state = data.state || '';

      if (data.goals) {
        franchiseGoals.salesGoal = safeNumber(data.goals.salesGoal, franchiseGoals.salesGoal);
        franchiseGoals.conversionGoal = safeNumber(data.goals.conversionGoal, franchiseGoals.conversionGoal);
        franchiseGoals.ticketGoal = safeNumber(data.goals.ticketGoal, franchiseGoals.ticketGoal);
      }

      monthTotals.sales = safeNumber(data.totals?.sales, data.designers?.reduce((s,d)=>s+safeNumber(d.monthlySales),0) || 0);
      monthTotals.avgTicket = safeNumber(data.totals?.avgTicket, 0);
      monthTotals.conversion = safeNumber(data.totals?.conversion, 0);

      designers = (data.designers || []).map((d, i) => ({
        id: d.id ?? (i+1),
        name: d.name,
        monthlySales: safeNumber(d.monthlySales),
        appointments: safeNumber(d.appointments),
        salesClosed: safeNumber(d.salesClosed),
        monthlyGoal: safeNumber(d.goal),
        avgTicket: safeNumber(d.avgTicket),
        conversionRate: safeNumber(d.conversionRate)
      }));

      paintHeader();
      updateGoalCards();
      renderDesignerTable();
      prepareForms();
    }

    // Sample fallback
    function sampleFranchise() {
      return {
        name: 'Downtown Store',
        city: 'Seattle',
        state: 'WA',
        goals: { salesGoal: 150000, conversionGoal: 65, ticketGoal: 1800 },
        totals: { sales: 127450, avgTicket: 1625, conversion: 53.3 },
        designers: [
          { id: 1, name: "Sarah Johnson", monthlySales: 45200, appointments: 15, salesClosed: 8,  goal: 50000, avgTicket: 2050, conversionRate: 72 },
          { id: 2, name: "Mike Chen",     monthlySales: 38900, appointments: 12, salesClosed: 5,  goal: 45000, avgTicket: 1900, conversionRate: 65 },
          { id: 3, name: "Emily Rodriguez", monthlySales: 42750, appointments: 18, salesClosed: 7, goal: 48000, avgTicket: 1750, conversionRate: 58 }
        ]
      };
    }

    // ========= Paint header + goals =========
    function paintHeader() {
      document.getElementById('storeTitle').textContent = 'Sales Performance Dashboard';
      document.getElementById('storeLocation').textContent =
        franchiseMeta.name + (franchiseMeta.city ? ` • ${franchiseMeta.city}, ${franchiseMeta.state}` : '');

      // set month selector
      document.getElementById('monthSelect').value = currentMonth;
    }

    function updateGoalCards() {
      document.getElementById('franchiseSalesGoal').textContent = fmtMoney(franchiseGoals.salesGoal);
      document.getElementById('franchiseConversionGoal').textContent = franchiseGoals.conversionGoal + '%';
      document.getElementById('franchiseTicketGoal').textContent = fmtMoney(franchiseGoals.ticketGoal);

      // Current values (from totals or designer averages)
      const currentSales = monthTotals.sales;
      const currentConversion =
        designers.length ? designers.reduce((s,d)=>s + safeNumber(d.conversionRate),0) / designers.length : monthTotals.conversion;
      const currentTicket =
        designers.length ? Math.round(designers.reduce((s,d)=>s + safeNumber(d.avgTicket),0) / designers.length) : monthTotals.avgTicket;

      document.getElementById('currentSales').textContent = fmtMoney(currentSales);
      document.getElementById('currentConv').textContent = isFinite(currentConversion) ? currentConversion.toFixed(1) + '%' : '—%';
      document.getElementById('currentTicket').textContent = fmtMoney(currentTicket);

      const salesProgress = Math.min((currentSales / Math.max(1, franchiseGoals.salesGoal)) * 100, 100);
      const convProgress = Math.min((currentConversion / Math.max(1, franchiseGoals.conversionGoal)) * 100, 100);
      const ticketProgress = Math.min((currentTicket / Math.max(1, franchiseGoals.ticketGoal)) * 100, 100);

      document.getElementById('salesBar').style.width = salesProgress + '%';
      document.getElementById('salesPct').textContent = Math.round(salesProgress) + '% of goal';

      document.getElementById('convBar').style.width = convProgress + '%';
      document.getElementById('convPct').textContent = Math.round(convProgress) + '% of goal';

      document.getElementById('ticketBar').style.width = ticketProgress + '%';
      document.getElementById('ticketPct').textContent = Math.round(ticketProgress) + '% of goal';
    }

    // ========= Table =========
    function renderDesignerTable() {
      const tbody = document.getElementById('designerTableBody');
      tbody.innerHTML = '';

      // rank by monthlySales among current designers
      const bySales = [...designers].sort((a,b)=>b.monthlySales - a.monthlySales);

      designers.forEach(d => {
        const avgTicket = d.salesClosed > 0 ? Math.round(d.monthlySales / d.salesClosed) : (d.avgTicket || 0);
        const closingRate = d.appointments > 0 ? ((d.salesClosed / d.appointments) * 100).toFixed(1) : (d.conversionRate || 0);
        const goalPercentage = ((d.monthlySales / Math.max(1, d.monthlyGoal)) * 100).toFixed(1);
        const salesRank = bySales.findIndex(x => x.id === d.id) + 1;

        const ticketVsGoal = franchiseGoals.ticketGoal > 0 ? ((avgTicket / franchiseGoals.ticketGoal) * 100).toFixed(0) : 0;
        const closingVsGoal = franchiseGoals.conversionGoal > 0 ? ((closingRate / franchiseGoals.conversionGoal) * 100).toFixed(0) : 0;

        const getBadge = (pct) => pct >= 100 ? 'bg-green-100 text-green-800' : pct >= 75 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
        const goalColor = (pct) => pct >= 100 ? 'text-green-600 font-semibold' : pct >= 80 ? 'text-yellow-600 font-medium' : 'text-red-600';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-gray-900">${d.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fmtMoney(d.monthlySales)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${salesRank===1?'bg-yellow-100 text-yellow-800':salesRank<=2?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}">#${salesRank}</span>
            <div class="text-xs text-gray-500 mt-1">of ${designers.length}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="text-gray-900">${fmtMoney(avgTicket)}</div>
            <div class="text-xs ${goalColor(ticketVsGoal)}">${ticketVsGoal}% of goal</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="text-gray-900">${closingRate}%</div>
            <div class="text-xs ${goalColor(closingVsGoal)}">${closingVsGoal}% of goal</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.appointments}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.salesClosed}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fmtMoney(d.monthlyGoal)}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadge(goalPercentage)}">${goalPercentage}%</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="space-y-1">
              <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-500">Ticket:</span>
                <span class="text-xs ${goalColor(ticketVsGoal)}">${ticketVsGoal}%</span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-500">Close:</span>
                <span class="text-xs ${goalColor(closingVsGoal)}">${closingVsGoal}%</span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-500">Rank:</span>
                <span class="text-xs font-medium">#${salesRank}</span>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-3">
              <button class="edit-designer-btn text-blue-600 hover:text-blue-900" data-id="${d.id}">Edit</button>
              <button class="delete-designer-btn text-red-600 hover:text-red-900" data-id="${d.id}">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // wire actions
      document.querySelectorAll('.edit-designer-btn').forEach(b=>b.addEventListener('click', () => editDesigner(+b.dataset.id)));
      document.querySelectorAll('.delete-designer-btn').forEach(b=>b.addEventListener('click', () => showDeleteConfirmation(+b.dataset.id)));
    }

    // ========= Forms + Modals logic (front-end only) =========
    function prepareForms(){
      // Goals modal month text
      const [y,m]=currentMonth.split('-'); const dt=new Date(+y, +m-1, 1);
      document.getElementById('goalsMonthDisplay').textContent = dt.toLocaleDateString('en-US',{month:'long',year:'numeric'});
      document.getElementById('franchiseGoalsMonthSelect').value = currentMonth;
      document.getElementById('franchiseGoalsMonthDisplay').textContent = dt.toLocaleDateString('en-US',{month:'long',year:'numeric'});

      // Goals upload per designer
      const form = document.getElementById('goalsForm'); form.innerHTML='';
      designers.forEach(d=>{
        const div = document.createElement('div');
        div.className='flex items-center space-x-4';
        div.innerHTML = `
          <div class="flex-1"><label class="block text-sm font-medium text-gray-700">${d.name}</label></div>
          <div class="flex-1"><input type="number" data-id="${d.id}" value="${d.monthlyGoal}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Monthly Goal"></div>
        `;
        form.appendChild(div);
      });

      // Update progress
      const prog = document.getElementById('progressForm'); prog.innerHTML='';
      designers.forEach(d=>{
        const div = document.createElement('div');
        div.className='bg-gray-50 p-4 rounded-lg';
        div.innerHTML = `
          <h4 class="font-medium text-gray-800 mb-3">${d.name}</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Weekly Sales ($)</label>
              <input type="number" data-id="${d.id}" data-field="monthlySales" value="${d.monthlySales}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Appointments</label>
              <input type="number" data-id="${d.id}" data-field="appointments" value="${d.appointments}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Sales Closed</label>
              <input type="number" data-id="${d.id}" data-field="salesClosed" value="${d.salesClosed}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Monthly Goal ($)</label>
              <input type="number" data-id="${d.id}" data-field="monthlyGoal" value="${d.monthlyGoal}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-orange-500">
            </div>
          </div>
        `;
        prog.appendChild(div);
      });
    }

    function editDesigner(id){
      const d = designers.find(x => x.id === id); if(!d) return;
      editingDesignerId = id;
      document.getElementById('editDesignerName').value = d.name;
      document.getElementById('editDesignerGoal').value = d.monthlyGoal;
      show('editDesignerModal');
    }

    function showDeleteConfirmation(id){
      const d = designers.find(x => x.id === id); if(!d) return;
      deletingDesignerId = id;
      document.getElementById('deleteDesignerName').textContent = d.name;
      show('deleteDesignerModal');
    }

    // ======= Modal helpers =======
    function show(id){ const el=document.getElementById(id); el.classList.remove('hidden'); el.classList.add('flex'); }
    function hide(id){ const el=document.getElementById(id); el.classList.add('hidden'); el.classList.remove('flex'); }

    // ======= Event listeners =======
    function setupEvents(){
      // Views
      document.getElementById('weeklyView').addEventListener('click',()=>switchView('weekly'));
      document.getElementById('monthlyView').addEventListener('click',()=>switchView('monthly'));
      document.getElementById('quarterlyView').addEventListener('click',()=>switchView('quarterly'));
      document.getElementById('ytdView').addEventListener('click',()=>switchView('ytd'));

      // Month change
      document.getElementById('monthSelect').addEventListener('change', (e)=>{
        currentMonth = e.target.value;
        // keep slug, update URL for bookmarking
        const u = new URL(location.href);
        u.searchParams.set('month', currentMonth);
        u.searchParams.set('slug', slug);
        history.replaceState(null,'',u.toString());
        loadFranchise();
      });

      // Buttons open modals
      document.getElementById('addDesignerBtn').addEventListener('click', ()=>show('addDesignerModal'));
      document.getElementById('uploadGoalsBtn').addEventListener('click', ()=>show('uploadGoalsModal'));
      document.getElementById('updateProgressBtn').addEventListener('click', ()=>show('updateProgressModal'));
      document.getElementById('newMonthBtn').addEventListener('click', ()=>show('newMonthModal'));
      document.getElementById('setFranchiseGoalsBtn').addEventListener('click', ()=>{
        // preload fields
        document.getElementById('franchiseGoalsMonthSelect').value = currentMonth;
        document.getElementById('franchiseSalesGoalInput').value = franchiseGoals.salesGoal;
        document.getElementById('franchiseConversionGoalInput').value = franchiseGoals.conversionGoal;
        document.getElementById('franchiseTicketGoalInput').value = franchiseGoals.ticketGoal;
        const [y,m]=currentMonth.split('-'); const dt=new Date(+y,+m-1,1);
        document.getElementById('franchiseGoalsMonthDisplay').textContent = dt.toLocaleDateString('en-US',{month:'long',year:'numeric'});
        show('franchiseGoalsModal');
      });

      // Close modals
      document.getElementById('cancelAddDesigner').addEventListener('click',()=>hide('addDesignerModal'));
      document.getElementById('cancelEditDesigner').addEventListener('click',()=>hide('editDesignerModal'));
      document.getElementById('cancelUploadGoals').addEventListener('click',()=>hide('uploadGoalsModal'));
      document.getElementById('cancelUpdateProgress').addEventListener('click',()=>hide('updateProgressModal'));
      document.getElementById('cancelNewMonth').addEventListener('click',()=>hide('newMonthModal'));
      document.getElementById('cancelFranchiseGoals').addEventListener('click',()=>hide('franchiseGoalsModal'));
      document.getElementById('cancelDeleteDesigner').addEventListener('click',()=>hide('deleteDesignerModal'));

      // Confirm delete
      document.getElementById('confirmDeleteDesigner').addEventListener('click', ()=>{
        if(!deletingDesignerId) return;
        designers = designers.filter(d=>d.id !== deletingDesignerId);
        deletingDesignerId = null;
        renderDesignerTable();
        prepareForms();
        hide('deleteDesignerModal');
      });

      // Add designer (client-side only)
      document.getElementById('addDesignerForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = document.getElementById('designerName').value.trim();
        const goal = parseInt(document.getElementById('designerGoal').value,10) || 0;
        const nextId = designers.length ? Math.max(...designers.map(d=>d.id))+1 : 1;
        designers.push({ id: nextId, name, monthlySales:0, appointments:0, salesClosed:0, monthlyGoal:goal, avgTicket:0, conversionRate:0 });
        renderDesignerTable(); prepareForms(); hide('addDesignerModal'); e.target.reset();
      });

      // Edit designer
      document.getElementById('editDesignerForm').addEventListener('submit',(e)=>{
        e.preventDefault();
        const d = designers.find(x=>x.id===editingDesignerId); if(!d) return;
        d.name = document.getElementById('editDesignerName').value.trim();
        d.monthlyGoal = parseInt(document.getElementById('editDesignerGoal').value,10) || d.monthlyGoal;
        renderDesignerTable(); prepareForms(); hide('editDesignerModal'); editingDesignerId=null;
      });

      // Save goals
      document.getElementById('saveGoals').addEventListener('click', ()=>{
        document.querySelectorAll('#goalsForm input[data-id]').forEach(inp=>{
          const id = +inp.dataset.id; const d = designers.find(x=>x.id===id); if (d) d.monthlyGoal = parseInt(inp.value,10)||0;
        });
        renderDesignerTable(); prepareForms(); hide('uploadGoalsModal');
      });

      // Save progress
      document.getElementById('saveProgress').addEventListener('click', ()=>{
        document.querySelectorAll('#progressForm input[data-id]').forEach(inp=>{
          const id = +inp.dataset.id; const field = inp.dataset.field;
          const d = designers.find(x=>x.id===id); if (d) d[field] = parseInt(inp.value,10)||0;
        });
        renderDesignerTable(); prepareForms(); hide('updateProgressModal');
      });

      // Save franchise goals (client-side only)
      document.getElementById('franchiseGoalsForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        currentMonth = document.getElementById('franchiseGoalsMonthSelect').value;
        franchiseGoals.salesGoal = parseInt(document.getElementById('franchiseSalesGoalInput').value,10)||franchiseGoals.salesGoal;
        franchiseGoals.conversionGoal = parseFloat(document.getElementById('franchiseConversionGoalInput').value)||franchiseGoals.conversionGoal;
        franchiseGoals.ticketGoal = parseInt(document.getElementById('franchiseTicketGoalInput').value,10)||franchiseGoals.ticketGoal;

        // reflect in URL/month select
        const u = new URL(location.href);
        u.searchParams.set('month', currentMonth);
        u.searchParams.set('slug', slug);
        history.replaceState(null,'',u.toString());
        document.getElementById('monthSelect').value = currentMonth;

        updateGoalCards();
        hide('franchiseGoalsModal');
      });

      // New month (client reset)
      document.getElementById('newMonthForm').addEventListener('submit',(e)=>{
        e.preventDefault();
        const newMonth = document.getElementById('newMonthInput').value;
        if(!newMonth) return;
        currentMonth = newMonth;

        // reset designer running stats for the new month (purely front-end)
        designers.forEach(d => { d.monthlySales=0; d.appointments=0; d.salesClosed=0; });

        // update URL + selector
        const u = new URL(location.href);
        u.searchParams.set('month', currentMonth);
        u.searchParams.set('slug', slug);
        history.replaceState(null,'',u.toString());
        document.getElementById('monthSelect').value = currentMonth;

        updateGoalCards();
        renderDesignerTable();
        prepareForms();
        hide('newMonthModal');
      });
    }

    function switchView(view){
      currentView = view;
      document.querySelectorAll('[id$="View"]').forEach(btn=>{
        btn.className='px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
      });
      document.getElementById(view + 'View').className='px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';

      const periods = {
        weekly: 'Week of September 2-8, 2025',
        monthly: 'September 2025',
        quarterly: 'Q3 2025',
        ytd: 'January - September 2025'
      };
      document.getElementById('currentViewTitle').textContent =
        view[0].toUpperCase() + view.slice(1) + ' View';
      document.getElementById('currentPeriod').textContent = periods[view];
    }

    // ========= Init =========
    (function init(){
      setupEvents();
      switchView('weekly');
      loadFranchise();
    })();
  </script>
</body>
</html>
