<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Regional Performance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .btn { @apply px-4 py-2 rounded-lg font-medium; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-muted { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
    .btn-green { @apply bg-green-600 text-white hover:bg-green-700; }
    .btn-blue { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-purple { @apply bg-purple-600 text-white hover:bg-purple-700; }
    .btn-red { @apply bg-red-600 text-white hover:bg-red-700; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen">
  <div id="toast" class="fixed top-4 right-4 hidden"></div>

  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Regional Performance Dashboard</h1>
          <p class="text-gray-600" id="regionSummary">Canada Region ‚Äî 0 Franchise Locations</p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <!-- Region -->
          <select id="regionSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="canada" selected>Canada</option>
            <option value="pacific-northwest">Pacific Northwest</option>
            <option value="northeast">Northeast</option>
          </select>

          <!-- Month -->
          <select id="monthSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <!-- default to current-ish months -->
            <option value="2025-09" selected>September 2025</option>
            <option value="2025-10">October 2025</option>
            <option value="2025-11">November 2025</option>
            <option value="2025-12">December 2025</option>
          </select>

          <button id="refreshBtn" class="btn btn-blue">Refresh</button>
        </div>
      </div>

      <!-- View Toggle -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="weeklyView" class="btn btn-primary">Weekly</button>
        <button id="monthlyView" class="btn btn-muted">Monthly</button>
        <button id="quarterlyView" class="btn btn-muted">Quarterly</button>
        <button id="ytdView" class="btn btn-muted">YTD</button>
      </div>

      <!-- Rank Toggle -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-gray-700 py-2">Rank by:</span>
        <button id="rankBySales" class="btn bg-green-600 text-white">Sales</button>
        <button id="rankByClosing" class="btn btn-muted">Closing Rate</button>
        <button id="rankByTicket" class="btn btn-muted">Avg Ticket</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Active Designers</p>
            <p class="text-2xl font-bold text-indigo-600" id="totalDesigners">0</p>
            <p class="text-sm text-green-600" id="designersChange">‚Äî</p>
          </div>
          <div class="p-3 bg-indigo-100 rounded-full">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Avg Designer Performance</p>
            <p class="text-2xl font-bold text-green-600" id="avgDesignerPerformance">‚Äî</p>
            <p class="text-sm text-green-600" id="avgPerfChange">‚Äî</p>
          </div>
          <div class="p-3 bg-green-100 rounded-full">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Avg Sales Per Designer</p>
            <p class="text-2xl font-bold text-purple-600" id="avgSalesPerDesigner">‚Äî</p>
            <p class="text-sm text-green-600" id="avgSalesChange">‚Äî</p>
          </div>
          <div class="p-3 bg-purple-100 rounded-full">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Designer Table -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-gray-800">Regional Designer Performance Rankings</h2>
            <p class="text-gray-600">Current Period: <span id="currentPeriod">Week of September 2‚Äì8, 2025</span></p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button id="manageFranchisesBtn" class="btn btn-green">Manage Locations</button>
            <button id="exportDataBtn" class="btn btn-blue">Export Data</button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designer</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Franchise</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Sales</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Ticket</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversion Rate</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
            </tr>
          </thead>
          <tbody id="designerTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Rows injected -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Designers -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">‚≠ê Top Regional Designers</h3>
      <div class="space-y-4" id="topDesigners"></div>
    </div>
  </div>

  <!-- Manage Locations Modal -->
  <div id="manageModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">Manage Franchise Locations</h3>
        <button id="closeManage" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Add Location -->
      <div class="bg-green-50 rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-green-800 mb-3">Add New Franchise</h4>
        <form id="addLocationForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Slug (URL id)</label>
            <input id="locSlug" type="text" placeholder="tierney" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required />
            <p class="text-xs text-gray-500 mt-1">Lowercase letters, numbers, and dashes only.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input id="locName" type="text" placeholder="Team Tierney" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
            <input id="locCity" type="text" placeholder="Toronto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Province</label>
            <input id="locProvince" type="text" placeholder="Ontario" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required />
          </div>

          <div class="md:col-span-2 flex items-center gap-3">
            <button type="submit" class="btn btn-green">Save Location</button>
            <span id="locStatus" class="hidden text-sm"></span>
          </div>
        </form>
      </div>

      <!-- Existing Locations -->
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-800">Current Locations</h4>
          <button id="reloadLocations" class="btn btn-muted">Reload</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-white">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Slug</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">City</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Province</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
              </tr>
            </thead>
            <tbody id="locationsTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Rows injected -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== tiny helpers ======
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.className = 'fixed top-4 right-4 bg-black text-white text-sm rounded px-3 py-2 shadow';
      el.textContent = msg;
      setTimeout(() => { el.className = 'fixed top-4 right-4 hidden'; }, 2000);
    }

    function setBusy(btn, busy) {
      if (!btn) return;
      if (busy) {
        btn.dataset.label = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Working...';
        btn.classList.add('opacity-60', 'cursor-not-allowed');
      } else {
        btn.disabled = false;
        if (btn.dataset.label) btn.textContent = btn.dataset.label;
        btn.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    }

    // ====== state ======
    let currentView = 'weekly';
    let currentMonth = '2025-09';
    let currentRegion = 'canada';
    let currentRankingCriteria = 'sales';

    // endpoints (adjust if needed)
    const REGION_METRICS_ENDPOINT = '/api/metrics/region';
    const FRANCHISES_CREATE_ENDPOINT = '/api/franchises/create';
    const FRANCHISES_LIST_ENDPOINT = '/api/franchises/list';

    // ====== init ======
    function init() {
      bindUI();
      refreshData();
    }

    function bindUI() {
      // views
      $('#weeklyView').addEventListener('click', () => switchView('weekly'));
      $('#monthlyView').addEventListener('click', () => switchView('monthly'));
      $('#quarterlyView').addEventListener('click', () => switchView('quarterly'));
      $('#ytdView').addEventListener('click', () => switchView('ytd'));

      // ranking
      $('#rankBySales').addEventListener('click', () => switchRanking('sales'));
      $('#rankByClosing').addEventListener('click', () => switchRanking('closing'));
      $('#rankByTicket').addEventListener('click', () => switchRanking('ticket'));

      // selects
      $('#monthSelect').addEventListener('change', (e) => {
        currentMonth = e.target.value;
        refreshData();
      });
      $('#regionSelect').addEventListener('change', (e) => {
        currentRegion = e.target.value;
        refreshData();
      });

      // refresh
      $('#refreshBtn').addEventListener('click', () => refreshData());

      // manage modal
      $('#manageFranchisesBtn').addEventListener('click', async () => {
        await loadLocationsList();
        showModal('#manageModal');
      });
      $('#closeManage').addEventListener('click', () => hideModal('#manageModal'));
      $('#reloadLocations').addEventListener('click', loadLocationsList);

      // add location form
      $('#addLocationForm').addEventListener('submit', addLocation);

      // export
      $('#exportDataBtn').addEventListener('click', exportData);
    }

    function showModal(sel) {
      const el = $(sel);
      if (!el) return;
      el.classList.remove('hidden');
      el.classList.add('flex');
    }
    function hideModal(sel) {
      const el = $(sel);
      if (!el) return;
      el.classList.add('hidden');
      el.classList.remove('flex');
    }

    // ====== data fetching / rendering ======
    async function refreshData() {
      try {
        const url = `${REGION_METRICS_ENDPOINT}?region=${encodeURIComponent(currentRegion)}&month=${encodeURIComponent(currentMonth)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Metrics error: ${res.status}`);
        const data = await res.json();

        // data shape: { "<franchise-slug>": { totals: {...}, designers: [...] }, ... }
        renderFromMetrics(data);
      } catch (err) {
        console.error(err);
        showToast('Failed to load metrics');
      }
    }

    function renderFromMetrics(regionData) {
      // Flatten designers
      const allDesigners = [];
      let franchiseCount = 0;

      Object.entries(regionData || {}).forEach(([slug, bundle]) => {
        franchiseCount++;
        (bundle.designers || []).forEach(d => {
          allDesigners.push({
            ...d,
            franchiseSlug: slug,
            franchiseName: d.franchiseName || slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
            avgTicket: d.avgTicket ?? Math.round((d.monthlySales || 0) / Math.max(1, d.salesClosed || 1)),
            conversionRate: d.conversionRate ?? d.closingRate ?? 0
          });
        });
      });

      // KPIs
      const totalDesigners = allDesigners.length;
      const totalSales = allDesigners.reduce((s, d) => s + (d.monthlySales || 0), 0);
      const avgSalesPerDesigner = totalDesigners ? Math.round(totalSales / totalDesigners) : 0;
      const avgPerformancePct = totalDesigners
        ? (allDesigners.reduce((s, d) => s + (d.monthlySales / Math.max(1, d.monthlyGoal || d.goal || d.monthlySales || 1)), 0) / totalDesigners) * 100
        : 0;

      $('#regionSummary').textContent = `${regionLabel(currentRegion)} ‚Äî ${franchiseCount} Franchise Location${franchiseCount === 1 ? '' : 's'}`;
      $('#totalDesigners').textContent = totalDesigners;
      $('#avgSalesPerDesigner').textContent = avgSalesPerDesigner ? `$${avgSalesPerDesigner.toLocaleString()}` : '‚Äî';
      $('#avgDesignerPerformance').textContent = isFinite(avgPerformancePct) && avgPerformancePct > 0 ? `${avgPerformancePct.toFixed(1)}%` : '‚Äî';
      $('#designersChange').textContent = '';
      $('#avgPerfChange').textContent = '';
      $('#avgSalesChange').textContent = '';

      // sort & render table by criteria
      let sorted = [...allDesigners];
      sorted.sort((a, b) => {
        if (currentRankingCriteria === 'sales') return (b.monthlySales || 0) - (a.monthlySales || 0);
        if (currentRankingCriteria === 'closing') return (b.conversionRate || 0) - (a.conversionRate || 0);
        if (currentRankingCriteria === 'ticket') return (b.avgTicket || 0) - (a.avgTicket || 0);
        return 0;
      });

      // render table
      const body = $('#designerTableBody');
      body.innerHTML = '';
      sorted.forEach((d, idx) => {
        const rank = idx + 1;
        const goalPct = d.goal ? (d.monthlySales / Math.max(1, d.goal)) * 100
                               : d.monthlyGoal ? (d.monthlySales / Math.max(1, d.monthlyGoal)) * 100
                                               : 0;

        const performanceIcon = goalPct >= 95 ? 'üåü' : goalPct >= 80 ? '‚úÖ' : goalPct >= 60 ? '‚ö†Ô∏è' : 'üî¥';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${rankBadge(rank)}">#${rank}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-gray-900">${d.name || '‚Äî'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-gray-900">
              <a href="/franchise/${encodeURIComponent(d.franchiseSlug)}" target="_blank" class="text-indigo-600 hover:underline">${d.franchiseName}</a>
            </div>
            <div class="text-xs text-gray-500">${d.franchiseSlug}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${(d.monthlySales || 0).toLocaleString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${(d.avgTicket || 0).toLocaleString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(d.conversionRate ?? 0)}%</td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-lg">${performanceIcon}</td>
        `;
        body.appendChild(tr);
      });

      // top designers
      const topContainer = $('#topDesigners');
      topContainer.innerHTML = '';
      sorted.slice(0, 5).forEach((d, i) => {
        const badge = i === 0 ? 'üèÜ' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '‚≠ê';
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        row.innerHTML = `
          <div class="flex items-center space-x-3">
            <span class="text-lg">${badge}</span>
            <div>
              <div class="font-medium text-gray-900">${d.name || '‚Äî'}</div>
              <div class="text-sm text-gray-500">
                <a href="/franchise/${encodeURIComponent(d.franchiseSlug)}" target="_blank" class="text-indigo-600 hover:underline">${d.franchiseName}</a>
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-semibold text-gray-900">$${(d.monthlySales || 0).toLocaleString()}</div>
            <div class="text-sm text-green-600">${(d.conversionRate ?? 0)}% close ‚Ä¢ $${(d.avgTicket || 0)}</div>
          </div>
        `;
        topContainer.appendChild(row);
      });
    }

    function rankBadge(rank) {
      if (rank === 1) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      if (rank <= 5) return 'bg-green-100 text-green-800 border-green-200';
      if (rank <= 15) return 'bg-blue-100 text-blue-800 border-blue-200';
      return 'bg-gray-100 text-gray-800 border-gray-200';
    }

    function regionLabel(slug) {
      if (slug === 'canada') return 'Canada Region';
      if (slug === 'pacific-northwest') return 'Pacific Northwest Region';
      if (slug === 'northeast') return 'Northeast Region';
      return slug;
    }

    function switchView(view) {
      currentView = view;
      $$('#weeklyView, #monthlyView, #quarterlyView, #ytdView').forEach(b => b.className = 'btn btn-muted');
      document.getElementById(view + 'View').className = 'btn btn-primary';

      const periods = {
        weekly: 'Week of September 2‚Äì8, 2025',
        monthly: 'September 2025',
        quarterly: 'Q3 2025',
        ytd: 'January ‚Äì September 2025'
      };
      $('#currentPeriod').textContent = periods[view] || periods.weekly;
    }

    function switchRanking(criteria) {
      currentRankingCriteria = criteria;
      $('#rankBySales').className = 'btn btn-muted';
      $('#rankByClosing').className = 'btn btn-muted';
      $('#rankByTicket').className = 'btn btn-muted';

      if (criteria === 'sales') $('#rankBySales').className = 'btn bg-green-600 text-white';
      if (criteria === 'closing') $('#rankByClosing').className = 'btn bg-blue-600 text-white';
      if (criteria === 'ticket') $('#rankByTicket').className = 'btn bg-purple-600 text-white';

      refreshData();
    }

    // ====== Add Location (UPDATED to open new tab) ======
    async function addLocation(e) {
      e.preventDefault();
      const slug = $('#locSlug').value.trim();
      const name = $('#locName').value.trim();
      const city = $('#locCity').value.trim();
      const province = $('#locProvince').value.trim();

      const status = $('#locStatus');
      status.className = 'hidden text-sm';

      if (!slug || !name || !city || !province) {
        status.textContent = 'All fields are required.';
        status.className = 'text-red-600 text-sm';
        return;
      }

      const submitBtn = $('#addLocationForm button[type="submit"]');
      setBusy(submitBtn, true);
      try {
        const res = await fetch(FRANCHISES_CREATE_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, name, city, province })
        });
        const body = await res.json().catch(() => ({}));

        if (!res.ok) {
          status.textContent = body?.error || 'Failed to save location.';
          status.className = 'text-red-600 text-sm';
          return;
        }

        status.textContent = 'Location saved.';
        status.className = 'text-emerald-700 text-sm';
        showToast('Location saved');

        // clear inputs
        $('#locSlug').value = '';
        $('#locName').value = '';
        $('#locCity').value = '';
        $('#locProvince').value = '';

        // refresh list and dashboard
        await loadLocationsList();
        await refreshData();

        // Open the new franchise dashboard in a new tab
      window.open(`/sales/?franchise=${encodeURIComponent(slug.toLowerCase())}`, '_blank');
      } catch (err) {
        console.error(err);
        status.textContent = 'Unexpected error.';
        status.className = 'text-red-600 text-sm';
      } finally {
        setBusy(submitBtn, false);
      }
    }

    // ====== Load Locations List (UPDATED: clickable slugs) ======
    async function loadLocationsList() {
      const body = $('#locationsTableBody');
      body.innerHTML = `
        <tr>
          <td class="px-3 py-4 text-sm text-gray-500" colspan="5">Loading‚Ä¶</td>
        </tr>
      `;

      try {
        const res = await fetch(FRANCHISES_LIST_ENDPOINT);
        if (!res.ok) throw new Error(`List error ${res.status}`);
        const rows = await res.json();

        body.innerHTML = '';
        if (!rows || rows.length === 0) {
          body.innerHTML = `
            <tr>
              <td class="px-3 py-4 text-sm text-gray-500" colspan="5">No locations yet.</td>
            </tr>
          `;
          return;
        }

        rows.forEach(r => {
          const tr = document.createElement('tr');
          const created = r.created_at ? new Date(r.created_at).toLocaleString() : '‚Äî';
          const slug = r.slug || '';
          tr.innerHTML = `
            <td class="px-3 py-2">
              <a href="/franchise/${encodeURIComponent(slug)}" target="_blank" class="text-indigo-600 hover:underline">
                ${slug}
              </a>
            </td>
            <td class="px-3 py-2">${r.name || ''}</td>
            <td class="px-3 py-2">${r.city || ''}</td>
            <td class="px-3 py-2">${r.province || ''}</td>
            <td class="px-3 py-2">${created}</td>
          `;
          body.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        body.innerHTML = `
          <tr>
            <td class="px-3 py-4 text-sm text-red-600" colspan="5">Failed to load locations.</td>
          </tr>
        `;
      }
    }

    // ====== Export CSV (simple) ======
    async function exportData() {
      try {
        const url = `${REGION_METRICS_ENDPOINT}?region=${encodeURIComponent(currentRegion)}&month=${encodeURIComponent(currentMonth)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Export fetch failed');
        const data = await res.json();

        const rows = [];
        rows.push(['Franchise', 'Designer', 'Monthly Sales', 'Avg Ticket', 'Conversion Rate']);
        Object.entries(data || {}).forEach(([slug, bundle]) => {
          (bundle.designers || []).forEach(d => {
            rows.push([
              slug,
              d.name || '',
              d.monthlySales || 0,
              (d.avgTicket ?? Math.round((d.monthlySales || 0) / Math.max(1, d.salesClosed || 1))),
              (d.conversionRate ?? d.closingRate ?? 0)
            ]);
          });
        });

        const csv = rows.map(r => r.map(v => typeof v === 'string' && v.includes(',') ? `"${v}"` : v).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const href = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = href;
        link.download = `regional_${currentRegion}_${currentMonth}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(href);
      } catch (err) {
        console.error(err);
        showToast('Export failed');
      }
    }

    // boot
    init();
  </script>
</body>
</html>
</body>
</html>
